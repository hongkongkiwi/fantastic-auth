import{r,j as e,ca as X,bz as H,a9 as J,cb as P,Z as W,bD as Z,m as q,bR as Q,bS as Y,B as ee,bT as se,D as ae,cc as $}from"./vendor-DTXcECKj.js";import{e as B,B as m,d as z,i as te,P as ie}from"./main-D_qbY1gz.js";import{C as g,a as U,b as O,c as D,d as w}from"./Card-ovhP7agJ.js";import{T as K,a as V,b as C,c as A}from"./Tabs-B49fZEnE.js";import{I as p}from"./Input-CvXUl1_l.js";import{S as F}from"./Switch-C_TaIxIx.js";import{A as ne,m as I}from"./vendor-motion-DirI8ZVJ.js";import"./internal-api-CvC1OOUg.js";import"./vendor-sonner-CauEFWQC.js";import"./vendor-sentry-DWdptYQI.js";import"./logger-BML-1mmb.js";const le={enabled:!1,provider:"",entityId:"",ssoUrl:"",certificate:"",signInUrl:"",nameIdFormat:"urn:oasis:names:tc:SAML:1.1:nameid-format:emailAddress",allowCreate:!0},re=[{value:"urn:oasis:names:tc:SAML:1.1:nameid-format:emailAddress",label:"Email Address"},{value:"urn:oasis:names:tc:SAML:1.1:nameid-format:unspecified",label:"Unspecified"},{value:"urn:oasis:names:tc:SAML:2.0:nameid-format:persistent",label:"Persistent"},{value:"urn:oasis:names:tc:SAML:2.0:nameid-format:transient",label:"Transient"}];function ce(){const[a,c]=r.useState(le),[j,v]=r.useState(!1),[b,k]=r.useState(!1),[N,f]=r.useState("idle"),[i,M]=r.useState("general"),[x,h]=r.useState(null),[E,T]=r.useState(null);r.useEffect(()=>{let s=!1;async function o(){try{const u=await fetch("/api/v1/admin/sso/saml/connections",{credentials:"include"});if(!u.ok)return;const d=(await u.json()).data?.[0];if(!d||s)return;h(d.id),c(G=>({...G,enabled:d.status==="active",provider:d.name||"",entityId:d.idp_entity_id||"",ssoUrl:d.idp_sso_url||"",signInUrl:d.idp_slo_url||"",nameIdFormat:d.name_id_format||G.nameIdFormat,allowCreate:d.jit_provisioning_enabled??!0}))}catch{}}return o(),()=>{s=!0}},[]);const l=async()=>{v(!0);try{const s={name:a.provider||"Default SAML",idp_entity_id:a.entityId||null,idp_sso_url:a.ssoUrl||null,idp_slo_url:a.signInUrl||null,idp_certificate:a.certificate||null,name_id_format:a.nameIdFormat,jit_provisioning_enabled:a.allowCreate,status:a.enabled?"active":"inactive"},o=x?`/api/v1/admin/sso/saml/connections/${x}`:"/api/v1/admin/sso/saml/connections",y=await fetch(o,{method:x?"PATCH":"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify(s)});if(!y.ok)throw new Error("Failed to save SAML configuration");if(!x){const d=await y.json();d.id&&h(d.id)}T(null),f("idle")}catch(s){T(s instanceof Error?s.message:"Failed to save SAML configuration")}finally{v(!1)}},L=async()=>{k(!0),f("idle");try{if(!x)throw new Error("Save configuration before testing");if(!(await fetch(`/api/v1/admin/sso/saml/connections/${x}/test`,{method:"POST",credentials:"include"})).ok)throw new Error("Connection test failed");f("success")}catch{f("error")}finally{k(!1)}},t=()=>{navigator.clipboard.writeText(`${window.location.origin}/api/auth/saml/metadata`)},n=()=>{navigator.clipboard.writeText(`${window.location.origin}/api/auth/saml/acs`)};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-bold tracking-tight",children:"SAML SSO Configuration"}),e.jsx("p",{className:"text-muted-foreground",children:"Configure SAML 2.0 single sign-on integration with your identity provider"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(F,{checked:a.enabled,onCheckedChange:s=>c({...a,enabled:s})}),e.jsx("span",{className:B("text-sm font-medium",a.enabled?"text-green-600":"text-muted-foreground"),children:a.enabled?"Enabled":"Disabled"})]})]}),E&&e.jsx("div",{className:"rounded-md border border-destructive/30 bg-destructive/5 p-3 text-sm text-destructive",children:E}),e.jsxs(K,{value:i,onValueChange:M,children:[e.jsxs(V,{children:[e.jsx(C,{value:"general",children:"General"}),e.jsx(C,{value:"provider",children:"Identity Provider"}),e.jsx(C,{value:"metadata",children:"Service Provider"})]}),e.jsx(A,{value:"general",className:"space-y-4",children:e.jsxs(g,{children:[e.jsxs(U,{children:[e.jsx(O,{children:"General Settings"}),e.jsx(D,{children:"Basic SAML configuration options"})]}),e.jsxs(w,{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium",htmlFor:"provider-name",children:"Provider Name"}),e.jsx(p,{id:"provider-name",placeholder:"e.g., Okta, Azure AD, OneLogin",value:a.provider,onChange:s=>c({...a,provider:s.target.value})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium",htmlFor:"name-id-format",children:"Name ID Format"}),e.jsx("select",{id:"name-id-format",className:"w-full rounded-md border border-input bg-background px-3 py-2 text-sm",value:a.nameIdFormat,onChange:s=>c({...a,nameIdFormat:s.target.value}),children:re.map(s=>e.jsx("option",{value:s.value,children:s.label},s.value))})]}),e.jsxs("div",{className:"flex items-center justify-between rounded-lg border p-4",children:[e.jsxs("div",{className:"space-y-0.5",children:[e.jsx("label",{className:"text-base font-medium",children:"Allow Account Creation"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Automatically create accounts for new users authenticated via SAML"})]}),e.jsx(F,{checked:a.allowCreate,onCheckedChange:s=>c({...a,allowCreate:s})})]})]})]})}),e.jsxs(A,{value:"provider",className:"space-y-4",children:[e.jsxs(g,{children:[e.jsxs(U,{children:[e.jsx(O,{children:"Identity Provider Settings"}),e.jsx(D,{children:"Configure your IdP connection details"})]}),e.jsxs(w,{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium",htmlFor:"entity-id",children:"Entity ID (Issuer)"}),e.jsx(p,{id:"entity-id",placeholder:"https://your-idp.com/saml/metadata",value:a.entityId,onChange:s=>c({...a,entityId:s.target.value})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium",htmlFor:"sso-url",children:"SSO URL (Login URL)"}),e.jsx(p,{id:"sso-url",placeholder:"https://your-idp.com/saml/sso",value:a.ssoUrl,onChange:s=>c({...a,ssoUrl:s.target.value})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium",htmlFor:"certificate",children:"X.509 Certificate"}),e.jsxs("div",{className:"relative",children:[e.jsx("textarea",{id:"certificate",rows:6,className:"w-full rounded-md border border-input bg-background px-3 py-2 text-sm font-mono",placeholder:`-----BEGIN CERTIFICATE-----
MIIDXTCCAkWg…
-----END CERTIFICATE-----`,value:a.certificate,onChange:s=>c({...a,certificate:s.target.value})}),e.jsxs(m,{variant:"outline",size:"sm",className:"absolute right-2 top-2",onClick:()=>document.getElementById("cert-upload")?.click(),children:[e.jsx(X,{className:"mr-2 h-4 w-4"}),"Upload"]}),e.jsx("input",{id:"cert-upload",type:"file",accept:".pem,.crt,.cer",className:"hidden",onChange:s=>{const o=s.target.files?.[0];if(o){const u=new FileReader;u.onload=y=>{c({...a,certificate:y.target?.result})},u.readAsText(o)}}})]})]})]})]}),e.jsx(ne,{children:N!=="idle"&&e.jsx(I.div,{initial:{opacity:0,y:-10},animate:{opacity:1,y:0},exit:{opacity:0,y:-10},children:N==="success"?e.jsxs("div",{className:"flex items-center gap-2 rounded-lg bg-green-50 p-4 text-green-800 dark:bg-green-900/20 dark:text-green-400",children:[e.jsx(H,{className:"h-5 w-5"}),e.jsx("span",{children:"Connection test successful! SAML SSO is properly configured."})]}):e.jsxs("div",{className:"flex items-center gap-2 rounded-lg bg-red-50 p-4 text-red-800 dark:bg-red-900/20 dark:text-red-400",children:[e.jsx(J,{className:"h-5 w-5"}),e.jsx("span",{children:"Connection test failed. Please verify your configuration."})]})})})]}),e.jsx(A,{value:"metadata",className:"space-y-4",children:e.jsxs(g,{children:[e.jsxs(U,{children:[e.jsx(O,{children:"Service Provider Metadata"}),e.jsx(D,{children:"Share these details with your identity provider"})]}),e.jsxs(w,{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium",children:"SP Metadata URL"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("code",{className:"flex-1 rounded bg-muted px-3 py-2 text-sm",children:typeof window<"u"?`${window.location.origin}/api/auth/saml/metadata`:""}),e.jsx(m,{variant:"outline",size:"icon","aria-label":"Copy SP metadata URL",onClick:t,children:e.jsx(P,{className:"h-4 w-4"})}),e.jsx(m,{variant:"outline",size:"icon","aria-label":"Open SP metadata",asChild:!0,children:e.jsx("a",{href:"/api/auth/saml/metadata",target:"_blank",rel:"noopener noreferrer",children:e.jsx(W,{className:"h-4 w-4"})})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium",children:"ACS (Assertion Consumer Service) URL"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("code",{className:"flex-1 rounded bg-muted px-3 py-2 text-sm",children:typeof window<"u"?`${window.location.origin}/api/auth/saml/acs`:""}),e.jsx(m,{variant:"outline",size:"icon","aria-label":"Copy ACS URL",onClick:n,children:e.jsx(P,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium",children:"SP Entity ID"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("code",{className:"flex-1 rounded bg-muted px-3 py-2 text-sm",children:"vault-saml"}),e.jsx(m,{variant:"outline",size:"icon","aria-label":"Copy SP entity ID",onClick:()=>navigator.clipboard.writeText("vault-saml"),children:e.jsx(P,{className:"h-4 w-4"})})]})]}),e.jsx("div",{className:"pt-4",children:e.jsxs(m,{variant:"outline",className:"w-full",children:[e.jsx(Z,{className:"mr-2 h-4 w-4"}),"Download SP Metadata XML"]})})]})]})})]}),e.jsxs("div",{className:"flex items-center justify-end gap-4",children:[e.jsx(m,{variant:"outline",onClick:L,disabled:b||!a.enabled,children:b?e.jsxs(e.Fragment,{children:[e.jsx(I.div,{className:"mr-2 h-4 w-4 animate-spin rounded-full border-2 border-current border-t-transparent"}),"Testing…"]}):e.jsxs(e.Fragment,{children:[e.jsx(q,{className:"mr-2 h-4 w-4"}),"Test Connection"]})}),e.jsx(m,{onClick:l,disabled:j,children:j?e.jsxs(e.Fragment,{children:[e.jsx(I.div,{className:"mr-2 h-4 w-4 animate-spin rounded-full border-2 border-current border-t-transparent"}),"Saving…"]}):"Save Configuration"})]})]})}const _={enabled:!1,clientId:"",clientSecret:"",scopes:"",allowedDomains:""},oe={google:{id:"google",..._,scopes:"openid email profile"},github:{id:"github",..._,scopes:"read:user user:email"},microsoft:{id:"microsoft",..._,scopes:"openid email profile"},apple:{id:"apple",..._,scopes:"name email"}},S=[{id:"google",name:"Google",description:"Sign in with Google accounts",icon:Q,envKey:"VITE_OAUTH_GOOGLE_ENABLED",defaultScopes:"openid email profile",docsUrl:"https://developers.google.com/identity/protocols/oauth2"},{id:"github",name:"GitHub",description:"Sign in with GitHub accounts",icon:Y,envKey:"VITE_OAUTH_GITHUB_ENABLED",defaultScopes:"read:user user:email",docsUrl:"https://docs.github.com/en/developers/apps/building-oauth-apps"},{id:"microsoft",name:"Microsoft",description:"Sign in with Microsoft/Azure AD accounts",icon:ee,envKey:"VITE_OAUTH_MICROSOFT_ENABLED",defaultScopes:"openid email profile",docsUrl:"https://docs.microsoft.com/en-us/azure/active-directory/develop/v2-oauth2-auth-code-flow"},{id:"apple",name:"Apple",description:"Sign in with Apple ID",icon:se,envKey:"VITE_OAUTH_APPLE_ENABLED",defaultScopes:"name email",docsUrl:"https://developer.apple.com/documentation/sign_in_with_apple"}];function R(a){return te[a.envKey]==="true"}function de(){const[a,c]=r.useState(oe),[j,v]=r.useState(!1),[b,k]=r.useState(!1),[N,f]=r.useState({}),[i,M]=r.useState(null),x=S.some(R),h=(t,n,s)=>{c(o=>({...o,[t]:{...o[t],[n]:s}}))},E=async()=>{v(!0);try{await new Promise(t=>setTimeout(t,1e3)),f(t=>{const n={...t};return S.forEach(s=>{a[s.id].clientSecret?.trim()&&(n[s.id]=!0)}),n}),c(t=>{const n={...t};return S.forEach(s=>{n[s.id].clientSecret?.trim()&&(n[s.id]={...n[s.id],clientSecret:""})}),n})}finally{v(!1)}},T=()=>{navigator.clipboard.writeText(`${window.location.origin}/api/auth/callback`)},l=i?S.find(t=>t.id===i):null,L=l?R(l):!1;return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-bold tracking-tight",children:"OAuth Providers"}),e.jsx("p",{className:"text-muted-foreground",children:"Configure social login providers for your application"})]}),!x&&e.jsx("div",{className:"rounded-lg bg-muted p-4 text-muted-foreground",children:e.jsx("p",{className:"text-sm",children:"No OAuth providers are enabled. Set the corresponding environment variables to enable social login."})}),e.jsx("div",{className:"grid gap-4 sm:grid-cols-2",children:S.map(t=>{const n=R(t),s=a[t.id],o=t.icon,u=i===t.id;return e.jsx(g,{className:B("relative cursor-pointer transition-colors",n?u?"border-primary bg-primary/5":"hover:border-primary/50":"cursor-not-allowed border-muted bg-muted/30 opacity-60"),onClick:()=>n&&M(t.id),children:e.jsxs(w,{className:"p-4",children:[!n&&e.jsx("div",{className:"absolute right-3 top-3",children:e.jsx(ae,{className:"h-4 w-4 text-muted-foreground"})}),e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:B("flex h-10 w-10 shrink-0 items-center justify-center rounded-lg",u&&n?"bg-primary text-primary-foreground":"bg-muted"),children:e.jsx(o,{className:"h-5 w-5"})}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"font-semibold",children:t.name}),s.enabled&&n&&e.jsx(z,{variant:"default",className:"text-xs",children:"Active"})]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:t.description}),n&&s.clientId&&e.jsxs("p",{className:"mt-1 text-xs text-muted-foreground",children:["Client ID: ",s.clientId.slice(0,8),"…"]}),!n&&e.jsxs("p",{className:"mt-2 text-xs text-muted-foreground",children:["Set ",t.envKey,"=true to enable"]})]})]})]})},t.id)})}),i&&L&&e.jsx(I.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},children:e.jsxs(g,{children:[e.jsxs(U,{children:[e.jsxs(O,{className:"flex items-center gap-2",children:[(()=>{const t=l?.icon||$;return e.jsx(t,{className:"h-5 w-5"})})(),l?.name," Configuration"]}),e.jsxs(D,{children:["Configure your ",l?.name," OAuth application credentials"]})]}),e.jsxs(w,{className:"space-y-6",children:[e.jsx("div",{className:"rounded-lg bg-blue-50 p-4 text-blue-800 dark:bg-blue-900/20 dark:text-blue-400",children:e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx($,{className:"mt-0.5 h-4 w-4 shrink-0"}),e.jsxs("div",{className:"text-sm",children:[e.jsx("p",{className:"font-medium",children:"Redirect URI"}),e.jsxs("p",{className:"mt-1",children:["Add this redirect URI to your ",l?.name," OAuth app:"]}),e.jsxs("div",{className:"mt-2 flex items-center gap-2",children:[e.jsx("code",{className:"flex-1 rounded bg-blue-100 px-2 py-1 text-xs dark:bg-blue-900/40",children:typeof window<"u"?`${window.location.origin}/api/auth/callback`:""}),e.jsx(m,{variant:"outline",size:"icon",className:"h-7 w-7",onClick:T,"aria-label":"Copy redirect URI",children:e.jsx(P,{className:"h-3 w-3"})})]})]})]})}),e.jsxs("div",{className:"flex items-center justify-between rounded-lg border p-4",children:[e.jsxs("div",{className:"space-y-0.5",children:[e.jsxs("span",{className:"text-base font-medium",children:["Enable ",l?.name," Login"]}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Allow users to sign in with ",l?.name]})]}),e.jsx(F,{checked:a[i].enabled,onCheckedChange:t=>h(i,"enabled",t)})]}),e.jsx("div",{className:"h-px bg-border"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{htmlFor:"client-id",className:"text-sm font-medium leading-none",children:"Client ID"}),e.jsx(p,{id:"client-id",value:a[i].clientId,onChange:t=>h(i,"clientId",t.target.value),placeholder:`Enter your ${l?.name} Client ID`})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("label",{htmlFor:"client-secret",className:"text-sm font-medium leading-none",children:"Client Secret"}),N[i]&&!a[i].clientSecret&&e.jsx(z,{variant:"outline",className:"text-xs",children:"Set"})]}),e.jsx(p,{id:"client-secret",type:b?"text":"password",value:a[i].clientSecret,onChange:t=>h(i,"clientSecret",t.target.value),placeholder:N[i]&&!a[i].clientSecret?"******** (set)":`Enter your ${l?.name} Client Secret`})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{htmlFor:"scopes",className:"text-sm font-medium leading-none",children:"Scopes"}),e.jsx(p,{id:"scopes",value:a[i].scopes,onChange:t=>h(i,"scopes",t.target.value),placeholder:l?.defaultScopes}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Space-separated list of OAuth scopes"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{htmlFor:"allowed-domains",className:"text-sm font-medium leading-none",children:"Allowed Domains (Optional)"}),e.jsx(p,{id:"allowed-domains",value:a[i].allowedDomains,onChange:t=>h(i,"allowedDomains",t.target.value),placeholder:"example.com, company.org"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Restrict login to specific email domains (comma-separated)"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(F,{id:"show-secrets",checked:b,onCheckedChange:k}),e.jsx("label",{htmlFor:"show-secrets",className:"text-sm font-medium leading-none",children:"Show Secrets"})]})]}),e.jsxs("div",{className:"flex items-center gap-2 text-sm text-muted-foreground",children:[e.jsx(H,{className:"h-4 w-4"}),e.jsxs("a",{href:l?.docsUrl,target:"_blank",rel:"noopener noreferrer",className:"hover:underline",children:["View ",l?.name," OAuth documentation"]})]})]})]})}),i&&!L&&e.jsx("div",{className:"rounded-lg bg-amber-50 p-4 text-amber-800 dark:bg-amber-900/20 dark:text-amber-400",children:e.jsxs("p",{className:"text-sm font-medium",children:["This provider is disabled. Set ",l?.envKey,"=true to enable."]})}),e.jsx("div",{className:"flex items-center justify-end gap-4",children:e.jsx(m,{onClick:E,disabled:j,children:j?e.jsxs(e.Fragment,{children:[e.jsx(I.div,{className:"mr-2 h-4 w-4 animate-spin rounded-full border-2 border-current border-t-transparent"}),"Saving…"]}):"Save Configuration"})})]})}function ye(){return e.jsxs("div",{className:"space-y-6",children:[e.jsx(ie,{title:"SSO & Integrations",description:"Configure SAML and OAuth providers",breadcrumbs:[{label:"Settings",href:"/settings"},{label:"SSO"}]}),e.jsxs(K,{defaultValue:"saml",className:"space-y-6",children:[e.jsxs(V,{children:[e.jsx(C,{value:"saml",children:"SAML"}),e.jsx(C,{value:"oauth",children:"OAuth"})]}),e.jsx(A,{value:"saml",className:"space-y-4",children:e.jsx(g,{className:"p-6",children:e.jsx(ce,{})})}),e.jsx(A,{value:"oauth",className:"space-y-4",children:e.jsx(g,{className:"p-6",children:e.jsx(de,{})})})]})]})}export{ye as component};
