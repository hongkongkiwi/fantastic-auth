{"version":3,"file":"router-manifest.js","sources":["../../src/router-manifest.ts"],"sourcesContent":["import { buildDevStylesUrl, rootRouteId } from '@tanstack/router-core'\nimport type { AnyRoute, RouterManagedTag } from '@tanstack/router-core'\nimport type { StartManifestWithClientEntry } from './transformAssetUrls'\n\n// Pre-computed constant for dev styles URL\nconst ROUTER_BASEPATH = process.env.TSS_ROUTER_BASEPATH || '/'\n\n/**\n * @description Returns the router manifest data that should be sent to the client.\n * This includes only the assets and preloads for the current route and any\n * special assets that are needed for the client. It does not include relationships\n * between routes or any other data that is not needed for the client.\n *\n * The client entry URL is returned separately so that it can be transformed\n * (e.g. for CDN rewriting) before being embedded into the `<script>` tag.\n *\n * @param matchedRoutes - In dev mode, the matched routes are used to build\n * the dev styles URL for route-scoped CSS collection.\n */\nexport async function getStartManifest(\n  matchedRoutes?: ReadonlyArray<AnyRoute>,\n): Promise<StartManifestWithClientEntry> {\n  const { tsrStartManifest } = await import('tanstack-start-manifest:v')\n  const startManifest = tsrStartManifest()\n\n  const rootRoute = (startManifest.routes[rootRouteId] =\n    startManifest.routes[rootRouteId] || {})\n\n  rootRoute.assets = rootRoute.assets || []\n\n  // Inject dev styles link in dev mode\n  if (process.env.TSS_DEV_SERVER === 'true' && matchedRoutes) {\n    const matchedRouteIds = matchedRoutes.map((route) => route.id)\n    rootRoute.assets.push({\n      tag: 'link',\n      attrs: {\n        rel: 'stylesheet',\n        href: buildDevStylesUrl(ROUTER_BASEPATH, matchedRouteIds),\n        'data-tanstack-router-dev-styles': 'true',\n      },\n    })\n  }\n\n  // Collect injected head scripts in dev mode (returned separately so we can\n  // build the client entry script tag after URL transforms are applied)\n  let injectedHeadScripts: string | undefined\n  if (process.env.TSS_DEV_SERVER === 'true') {\n    const mod = await import('tanstack-start-injected-head-scripts:v')\n    if (mod.injectedHeadScripts) {\n      injectedHeadScripts = mod.injectedHeadScripts\n    }\n  }\n\n  const manifest = {\n    routes: Object.fromEntries(\n      Object.entries(startManifest.routes).flatMap(([k, v]) => {\n        const result = {} as {\n          preloads?: Array<string>\n          assets?: Array<RouterManagedTag>\n        }\n        let hasData = false\n        if (v.preloads && v.preloads.length > 0) {\n          result['preloads'] = v.preloads\n          hasData = true\n        }\n        if (v.assets && v.assets.length > 0) {\n          result['assets'] = v.assets\n          hasData = true\n        }\n        if (!hasData) {\n          return []\n        }\n        return [[k, result]]\n      }),\n    ),\n  }\n\n  return {\n    manifest,\n    clientEntry: startManifest.clientEntry,\n    injectedHeadScripts,\n  }\n}\n"],"names":[],"mappings":";AAKA,MAAM,kBAAkB,QAAQ,IAAI,uBAAuB;AAc3D,eAAsB,iBACpB,eACuC;AACvC,QAAM,EAAE,iBAAA,IAAqB,MAAM,OAAO,2BAA2B;AACrE,QAAM,gBAAgB,iBAAA;AAEtB,QAAM,YAAa,cAAc,OAAO,WAAW,IACjD,cAAc,OAAO,WAAW,KAAK,CAAA;AAEvC,YAAU,SAAS,UAAU,UAAU,CAAA;AAGvC,MAAI,QAAQ,IAAI,mBAAmB,UAAU,eAAe;AAC1D,UAAM,kBAAkB,cAAc,IAAI,CAAC,UAAU,MAAM,EAAE;AAC7D,cAAU,OAAO,KAAK;AAAA,MACpB,KAAK;AAAA,MACL,OAAO;AAAA,QACL,KAAK;AAAA,QACL,MAAM,kBAAkB,iBAAiB,eAAe;AAAA,QACxD,mCAAmC;AAAA,MAAA;AAAA,IACrC,CACD;AAAA,EACH;AAIA,MAAI;AACJ,MAAI,QAAQ,IAAI,mBAAmB,QAAQ;AACzC,UAAM,MAAM,MAAM,OAAO,wCAAwC;AACjE,QAAI,IAAI,qBAAqB;AAC3B,4BAAsB,IAAI;AAAA,IAC5B;AAAA,EACF;AAEA,QAAM,WAAW;AAAA,IACf,QAAQ,OAAO;AAAA,MACb,OAAO,QAAQ,cAAc,MAAM,EAAE,QAAQ,CAAC,CAAC,GAAG,CAAC,MAAM;AACvD,cAAM,SAAS,CAAA;AAIf,YAAI,UAAU;AACd,YAAI,EAAE,YAAY,EAAE,SAAS,SAAS,GAAG;AACvC,iBAAO,UAAU,IAAI,EAAE;AACvB,oBAAU;AAAA,QACZ;AACA,YAAI,EAAE,UAAU,EAAE,OAAO,SAAS,GAAG;AACnC,iBAAO,QAAQ,IAAI,EAAE;AACrB,oBAAU;AAAA,QACZ;AACA,YAAI,CAAC,SAAS;AACZ,iBAAO,CAAA;AAAA,QACT;AACA,eAAO,CAAC,CAAC,GAAG,MAAM,CAAC;AAAA,MACrB,CAAC;AAAA,IAAA;AAAA,EACH;AAGF,SAAO;AAAA,IACL;AAAA,IACA,aAAa,cAAc;AAAA,IAC3B;AAAA,EAAA;AAEJ;"}